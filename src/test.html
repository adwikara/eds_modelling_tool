<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>
<body>
    <script>
        let year = 2018
        let api = 'qcS1rONVybE6Gtw1heDE0dFatuaHBmoVozd1weZX'
        let attributes = 'ghi,dhi,dni,wind_speed,air_temperature'
        let leapYear = 'false'
        let interval = '60'
        let utc = 'false'
        let name = 'Aditya+Wikara'
        let reason = 'academic+research'
        let affiliation = 'Boston+University'
        let email = 'adwikara@bu.edu'
        let mailingList = 'false'

        let invEff = 0.96 //4 percent of losses due to inverter
        let losses = 0.86 //14 percent of other losses
        let waterCleanEff = 0.99 //99% restoration after water cleaning
        let length = 365

        let gpoaAnnualDaily = []
        let annualEnergyEds = []
        let annualEnergyReg = []
        

        sysCap = 20000
        edsSlr = 0.05
        regSlr = 0.5
        edsFreq = 3
        waterFreq = 21
        edsCleanFreq = 180


        function getGpoaHourly(lat,lon) {
            let results
            let gpoaAnnualHourly = []
            let url = `http://developer.nrel.gov/api/solar/nsrdb_psm3_download.csv?wkt=POINT(${lon}%20${lat})&names=${year}&leap_day=${leapYear}&interval=${interval}&utc=${utc}&full_name=${name}&email=${email}&affiliation=${affiliation}&mailing_list=${mailingList}&reason=${reason}&api_key=${api}&attributes=${attributes}`
            axios.get(url)
            .then((response) => {
                results = response.data
                results = results.split("\n")
                results.pop()
                results.splice(0,3)
            });

            setTimeout(function() {
                for (i=0; i < 8760; i++) {
                    data = results[i].split(',')
                    gpoaAnnualHourly.push(data[5])
                }

            }, 9000)

            return gpoaAnnualHourly
        }

        function getGpoaDaily(lat,lon) {
            let results

            let url = `http://developer.nrel.gov/api/solar/nsrdb_psm3_download.csv?wkt=POINT(${lon}%20${lat})&names=${year}&leap_day=${leapYear}&interval=${interval}&utc=${utc}&full_name=${name}&email=${email}&affiliation=${affiliation}&mailing_list=${mailingList}&reason=${reason}&api_key=${api}&attributes=${attributes}`
            axios.get(url)
            .then((response) => {
                results = response.data
                results = results.split("\n")
                results.pop()
                results.splice(0,3)
            });

            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    let counter = 0
                    let sum = 0

                    for (i=0; i < 8760; i++) {
                        data = results[i].split(',')
                        if (counter == 23) {
                            gpoaAnnualDaily.push(sum/1000)
                            sum = 0
                            counter = 0
                        } else {
                            sum = sum + parseInt(data[5])
                            counter = counter + 1
                        }
                    }
                    const error = false;
                    if(!error) {
                        resolve()
                    } else {
                        reject('Error: Something went wrong')
                    }

                }, 9000);
            });
        }

        async function getEnergy(lat, lon, sysCap, edsSlr, regSlr, waterFreq, edsCleanFreq) {
            await getGpoaDaily(lat,lon)

            edsSlr = 1 - (edsSlr/100)
            regSlr = 1 - (regSlr/100)
            edsCounter = 0
            result = 1.00

            for (let i=0; i < gpoaAnnualDaily.length; i++) {
                if (edsCounter == edsCleanFreq-1) {
                    result = waterCleanEff
                    annualEnergyEds.push(result*parseInt(gpoaAnnualDaily[i])*sysCap*invEff*losses)
                    edsCounter = 0
                } else {
                    edsCounter = edsCounter + 1
                    result = result * edsSlr
                    annualEnergyEds.push(result*parseInt(gpoaAnnualDaily[i])*sysCap*invEff*losses)
                }
            }

            edsCounter = 0
            for (let i=0; i < gpoaAnnualDaily.length; i++) {
                if (edsCounter == waterFreq-1) {
                    result = waterCleanEff
                    annualEnergyReg.push(result*parseInt(annualEnergyReg[i])*sysCap*invEff*losses)
                    edsCounter = 0
                } else {
                    edsCounter = edsCounter + 1
                    result = result * regSlr
                    annualEnergyReg.push(result*parseInt(gpoaAnnualDaily[i])*sysCap*invEff*losses)
                }
            }
        }

        //gpoaHourly = getGPOAHourly(42,-71)
        //gpoaDaily = getGPOADaily(42,-71)
        //getEnergyEds(42, -71, sysCap, edsSlr, regSlr, edsFreq, waterFreq, edsCleanFreq)
        getEnergy(42, -71, sysCap, edsSlr, regSlr, waterFreq, edsCleanFreq)



    </script>
</body>
</html>